# 📋 DevOps Инструкция для Test Deploy App

## 🎯 Что это за проект?

Это **минимальный full-stack проект** с упором на **DevOps практики**. Проект демонстрирует современные подходы к развертыванию веб-приложений с использованием Docker, Nginx, SSL сертификатов и автоматизации.

### 🏗️ Архитектура проекта

#### **Development (Разработка):**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MetaAdmin     │    │   Frontend      │    │   Backend       │
│   (React CRA)   │    │   (Next.js)     │    │   (Express.js)  │
│   Port: 3000    │    │   Port: 4000    │    │   Port: 3500    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL   │
                    │   Database     │
                    │   Port: 5432   │
                    └─────────────────┘
```

#### **Production (Продакшен):**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MetaAdmin     │    │   Frontend      │    │   Backend       │
│   (React CRA)   │    │   (Next.js)     │    │   (Express.js)  │
│   admin.domain  │    │   client.domain │    │   api.domain    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │    Traefik      │
                    │ (Dynamic Router)│
                    │  Ports: 80, 443 │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL   │
                    │   Database     │
                    │   Port: 5432   │
                    └─────────────────┘
```

---

## 🔧 DevOps Компоненты

### 1. **Docker & Containerization** 🐳

**Что это:** Docker позволяет "упаковать" ваше приложение со всеми зависимостями в контейнер, который будет одинаково работать на любой машине.

**В проекте:**
- `backend/Dockerfile` - контейнер для Node.js сервера
- `frontend/Dockerfile` - контейнер для Next.js приложения  
- `nginx/Dockerfile` - контейнер для веб-сервера Nginx

**Простым языком:** Представьте, что Docker - это как коробка с готовым обедом. В коробке есть все: еда, тарелка, вилка. Где бы вы ни открыли коробку - обед будет одинаковый.

### 2. **Docker Compose** 🐙

**Что это:** Инструмент для управления несколькими контейнерами одновременно. Как дирижер оркестра - управляет всеми инструментами.

**В проекте:**
- `docker-compose.yml` - для разработки (development)
- `docker-compose.prod.yml` - для продакшена (production)

**Простым языком:** Если Docker - это коробка с обедом, то Docker Compose - это меню в ресторане, где вы заказываете сразу несколько блюд и они приходят вместе.

### 3. **Nginx Reverse Proxy** 🔄

**Что это:** Nginx - это "переводчик" между пользователями и вашим приложением. Он принимает запросы и направляет их к нужному сервису.

**В проекте:**
- `nginx/nginx.conf` - конфигурация веб-сервера
- Автоматический редирект HTTP → HTTPS
- Балансировка нагрузки между сервисами
- SSL/TLS терминация

**Простым языком:** Nginx - это как секретарь в офисе. К нему приходят все посетители, а он решает, к какому специалисту их направить.

### 4. **SSL/TLS Security** 🔐

**Что это:** SSL сертификаты обеспечивают шифрование данных между браузером и сервером. Безопасная передача информации.

**В проекте:**
- Автоматическое получение сертификатов от Let's Encrypt
- Принудительное перенаправление на HTTPS
- Security headers для защиты от атак

**Простым языком:** SSL - это как конверт для письма. Без конверта письмо может прочитать любой, а в конверте - только получатель.

### 5. **Database Persistence** 💾

**Что это:** PostgreSQL база данных с постоянным хранением данных. Информация не теряется при перезапуске контейнеров.

**В проекте:**
- Docker volume для хранения данных БД
- Health checks для мониторинга состояния
- Автоматическое создание таблиц при запуске

**Простым языком:** База данных - это как шкаф с документами. Даже если вы переставите шкаф в другую комнату, документы останутся на месте.

### 6. **MetaAdmin Panel** 🎛️

**Что это:** Отдельная админ-панель для управления компаниями в мультитенантной системе.

**В проекте:**
- React приложение для управления компаниями
- Простая аутентификация через куки
- CRUD операции для компаний
- Отдельный порт (3000) в development

**Простым языком:** MetaAdmin - это как диспетчерская в аэропорту. Отсюда управляют всеми рейсами (компаниями).

### 7. **Traefik Dynamic Router** 🚦

**Что это:** Современный reverse proxy с автоматическим обнаружением сервисов и динамической маршрутизацией.

**В проекте:**
- Автоматическое обнаружение новых компаний
- Динамическое создание маршрутов по доменам
- Автоматические SSL сертификаты
- Dashboard для мониторинга

**Простым языком:** Traefik - это как умный почтальон, который знает все адреса и автоматически доставляет письма по нужным домам.

---

## 🚀 Сценарии использования

### **Development (Разработка)** 🛠️

**Цель:** Быстрая разработка с hot-reload и отладкой

**Команда:**
```bash
docker compose up --build
```

**Что происходит:**
1. Создаются 4 контейнера: metaadmin, frontend, backend, postgresql
2. Код монтируется как volume (изменения видны сразу)
3. Порты открыты для прямого доступа
4. Traefik НЕ используется (упрощенная схема)

**Доступ:**
- MetaAdmin: http://localhost:3000
- Frontend: http://localhost:4000
- Backend: http://localhost:3500
- Database: localhost:5434

### **Production (Продакшен)** 🌐

**Цель:** Безопасный и оптимизированный деплой для пользователей

**Команда:**
```bash
docker compose -f docker-compose.traefik.yml up -d --build
```

**Что происходит:**
1. Создаются 5 контейнеров: traefik, metaadmin, frontend, backend, postgresql
2. Traefik работает как динамический роутер
3. SSL сертификаты для HTTPS
4. Автоматический редирект HTTP → HTTPS
5. Динамическая маршрутизация по доменам

**Доступ:**
- MetaAdmin: https://meta.justcreatedsite.ru
- Frontend: https://justcreatedsite.ru (тестовая компания)
- Backend API: https://api.justcreatedsite.ru
- Traefik Dashboard: https://traefik.justcreatedsite.ru
- Автоматический HTTPS

---

## 🔧 DevOps Практики в проекте

### 1. **Infrastructure as Code (IaC)** 📝

**Что это:** Вся инфраструктура описана в файлах конфигурации, а не настраивается вручную.

**В проекте:**
- Docker Compose файлы описывают всю архитектуру
- Nginx конфигурация в коде
- SSL настройки автоматизированы

**Преимущества:**
- Воспроизводимость (одинаково работает везде)
- Версионирование инфраструктуры
- Быстрое развертывание

### 2. **Environment Separation** 🌍

**Что это:** Разные настройки для разных сред (разработка/продакшен).

**В проекте:**
- `docker-compose.yml` - для разработки
- `docker-compose.prod.yml` - для продакшена
- `env.production.example` - переменные окружения

**Простым языком:** Как разные костюмы для разных случаев - дома халат, на работе костюм, на праздник - нарядное платье.

### 3. **Automated SSL Management** 🔄

**Что это:** Автоматическое получение и обновление SSL сертификатов.

**В проекте:**
- `scripts/setup-ssl.sh` - получение сертификата
- `scripts/renew-ssl.sh` - обновление сертификата
- Crontab для автоматического обновления

**Простым языком:** Как автоматическая подписка на журнал - сертификат обновляется сам, вам не нужно ничего делать.

### 4. **Health Checks** 🏥

**Что это:** Автоматическая проверка состояния сервисов.

**В проекте:**
- PostgreSQL health check в docker-compose
- Backend health endpoint `/api/health`
- Автоматический перезапуск при сбоях

**Простым языком:** Как датчик дыма в доме - если что-то не так, система сразу об этом узнает.

### 5. **Logging & Monitoring** 📊

**Что это:** Сбор и анализ логов для мониторинга работы системы.

**В проекте:**
- Traefik access/error logs
- Application logs в контейнерах
- Database logs для аудита
- Docker logs для отладки

**Простым языком:** Как видеонаблюдение в магазине - записывает все события для анализа.

### 6. **Multi-tenancy** 🏢

**Что это:** Архитектура, где одно приложение обслуживает множество клиентов (компаний).

**В проекте:**
- Каждая компания имеет свой домен
- Изоляция данных через companyId
- Динамическая маршрутизация через Traefik
- Общая инфраструктура для всех клиентов

**Простым языком:** Как многоквартирный дом - один дом, но у каждой квартиры свой адрес и замок.

### 7. **Dynamic CORS** 🔒

**Что это:** Динамическая настройка CORS в зависимости от окружения и доменов.

**В проекте:**
- Development: разрешены localhost домены
- Production: проверка доменов из базы данных
- Автоматическое разрешение новых клиентских доменов
- Безопасная работа с куками

**Простым языком:** Как охранник в офисе - в рабочее время пропускает всех сотрудников, а в нерабочее - только по списку.

---

## 🛠️ Технические детали

### **Docker Networking** 🌐

```yaml
networks:
  app-network:
    driver: bridge
```

**Что это:** Создается изолированная сеть для контейнеров. Они могут общаться друг с другом, но недоступны извне (кроме открытых портов).

### **Volume Management** 💾

```yaml
volumes:
  postgresql-data:
  nginx_logs:
```

**Что это:** Постоянное хранение данных. Даже если контейнер удалить, данные останутся.

### **Environment Variables** 🔧

```yaml
environment:
  - NODE_ENV=production
  - BACKEND_URL=http://backend:3500/api
```

**Что это:** Настройки приложения через переменные окружения. Легко менять без пересборки.

### **Security Headers** 🛡️

```nginx
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header Strict-Transport-Security "max-age=31536000";
```

**Что это:** HTTP заголовки для защиты от различных атак (XSS, clickjacking, etc.).

---

## 🎯 Преимущества такой архитектуры

### **Для разработчиков:**
- ✅ Быстрый старт проекта
- ✅ Одинаковая среда на всех машинах
- ✅ Легкое добавление новых сервисов
- ✅ Простая отладка

### **Для DevOps:**
- ✅ Автоматизированное развертывание
- ✅ Масштабируемость
- ✅ Мониторинг и логирование
- ✅ Безопасность из коробки

### **Для бизнеса:**
- ✅ Быстрый time-to-market
- ✅ Надежность системы
- ✅ Низкие операционные расходы
- ✅ Легкое масштабирование

---

## 🚀 Быстрый старт

### **Локальная разработка:**
```bash
# Клонируйте проект
git clone <your-repo>
cd test-deploy

# Запустите для разработки
docker compose up --build

# Заполните базу данных
./scripts/fillInitDB.sh

# Откройте:
# MetaAdmin: http://localhost:3000 (admin/qwerty)
# Frontend: http://localhost:4000 (admin/qwerty123)
```

### **Продакшен деплой:**
```bash
# На сервере
docker compose -f docker-compose.traefik.yml up -d --build

# Настройте DNS записи:
# meta.justcreatedsite.ru -> ваш IP
# justcreatedsite.ru -> ваш IP
# api.justcreatedsite.ru -> ваш IP
```

---

## 📚 Что изучить дальше

### **Для начинающих:**
1. Docker basics
2. Docker Compose
3. Nginx configuration
4. SSL/TLS basics

### **Для продвинутых:**
1. Kubernetes
2. CI/CD pipelines
3. Monitoring (Prometheus, Grafana)
4. Infrastructure automation (Terraform)

---

## 🎉 Заключение

Этот проект демонстрирует **современные DevOps практики** в миниатюре:

- **Containerization** - все в Docker
- **Orchestration** - Docker Compose управляет сервисами  
- **Dynamic Routing** - Traefik для автоматической маршрутизации
- **Multi-tenancy** - одна система для множества клиентов
- **Security** - SSL, security headers, изоляция данных
- **Automation** - автоматические сертификаты и маршруты
- **Monitoring** - логи и health checks
- **Persistence** - данные не теряются
- **Admin Panel** - управление через веб-интерфейс

**Простым языком:** Это как готовый рецепт для ресторанной сети - все ингредиенты, инструкции, автоматизация процессов и даже система управления филиалами. Остается только следовать рецепту! 🍳

---

*Создано для демонстрации DevOps практик в реальном проекте* 🚀
